# 音乐播放器产品化路线图 (Music Player Product Roadmap)

## 当前进度 (Current Status)
- [x] 基础硬件驱动 (SD卡, 音频DAC/Codec)
- [x] 文件系统 (FatFS)
- [x] 图形库集成 (LVGL v9)
- [x] 触屏驱动集成 (Touch)

## 阶段一：软件架构重构 (FreeRTOS 集成)
**目标**：引入实时操作系统，解决“界面卡顿”和“音频爆音”的冲突，实现多任务并行处理。

### 关键任务
1.  **FreeRTOS 移植**：在 STM32CubeMX 中启用 FreeRTOS，或手动移植。
2.  **任务划分**：
    *   `GUI_Task` (低优先级)：运行 `lv_timer_handler()`，负责界面刷新。
    *   `Audio_Task` (高优先级)：负责音频数据填充、解码、I2S DMA 传输管理。
    *   `File_Task` (中优先级)：负责从 SD 卡读取音乐文件数据到缓冲区。
3.  **任务间通信**：
    *   使用 **队列 (Queue)** 传递播放指令（如：UI 发送 "下一首" -> 音频任务）。
    *   使用 **二值信号量 (Binary Semaphore)** 或 **消息队列** 进行音频缓冲区的同步（当半传输中断触发时，通知文件任务读取数据）。
    *   使用 **互斥量 (Mutex)** 保护共享资源（如：FatFS，如果多个任务都要读写文件）。

### 📚 学习重点 (FreeRTOS)
*   **核心概念**：Task（任务创建与调度）、Priority（优先级配置）。
*   **同步与通信**：Queue（队列）、Semaphore（信号量）、Mutex（互斥量）。
*   **内存管理**：Heap 配置 (Heap_4.c)，栈溢出检测 (Stack Overflow Detection)。
*   **调试**：如何查看任务堆栈使用率，避免 Stack Overflow。

---

## 阶段二：UI/UX 深度开发 (LVGL 进阶)
**目标**：打造媲美市面产品的交互界面，不仅仅是“能显示”，要“好看且好用”。

### 关键任务
1.  **界面设计**：
    *   **主页**：封面显示 (Image)、播放进度条 (Slider)、控制按钮 (Button)、歌曲信息 (Label)。
    *   **列表页**：文件浏览器 (List/Table)，支持滑动浏览。
    *   **设置页**：音效设置、背光调节。
2.  **逻辑绑定**：
    *   点击“播放”按钮 -> 触发播放事件。
    *   拖动进度条 -> 触发 Seek 事件。
3.  **视觉优化**：
    *   使用自定义字体 (Font Converter) 显示中文歌名。
    *   添加过渡动画 (Animations) 和 屏幕切换效果。

### 📚 学习重点 (LVGL)
*   **基础控件**：`lv_btn` (按钮), `lv_label` (标签), `lv_slider` (滑块), `lv_img` (图片), `lv_list` (列表)。
*   **布局系统**：Flex (弹性布局) 和 Grid (网格布局)，这是适配不同屏幕尺寸的关键。
*   **样式与主题 (Styles & Themes)**：如何美化控件（圆角、渐变、阴影），而不是使用默认丑陋的样式。
*   **事件处理 (Events)**：`LV_EVENT_CLICKED`, `LV_EVENT_VALUE_CHANGED` 等。
*   **工具使用**：
    *   **SquareLine Studio** (强烈推荐)：可视化 UI 设计器，拖拉拽生成 LVGL 代码，极大提高效率。
    *   **LVGL Font Converter**：将 ttf 字体转换为 C 数组。
    *   **LVGL Image Converter**：将图片转换为 C 数组或 bin 文件。

---

## 阶段三：应用逻辑完善
**目标**：连接 UI 与底层驱动，实现完整的播放器功能。

### 关键任务
1.  **音乐扫描器**：遍历 SD 卡文件夹，筛选 `.mp3`, `.wav` 文件，生成播放列表。
2.  **ID3 解析**：解析 MP3 文件头，提取 歌名、歌手、专辑封面图片。
    *   *难点*：封面图片通常是 JPEG/PNG，需要集成 `libjpeg` 或 `lodepng` 解码，或者利用 LVGL 的图片解码接口。
3.  **音频处理**：
    *   实现 暂停/恢复、上一首/下一首。
    *   实现 进度条拖动（f_lseek）。
    *   (进阶) EQ 均衡器、频谱分析显示。

### 📚 学习重点
*   **FatFS**：`f_readdir` (目录读取), `f_stat` (文件信息), 长文件名支持 (LFN)。
*   **音频格式**：MP3 文件结构 (ID3v2 tags)，WAV 文件头格式。
*   **算法**：FFT (快速傅里叶变换) 用于制作频谱跳动效果 (使用 CMSIS-DSP 库)。

---

## 阶段四：硬件产品化 (PCB 设计)
**目标**：脱离开发板，设计自己的电路板。

### 关键任务
1.  **原理图设计 (Schematic)**：
    *   MCU: STM32F407VET6/ZGT6 (根据引脚需求选择)。
    *   Audio: DAC (如 PCM5102A) 或 Codec (如 ES8388/WM8978)。
    *   Power: 锂电池充电管理 (TP4056)，3.3V 稳压 (LDO)。
    *   Storage: MicroSD 卡槽。
    *   Display: FPC 连接座 (适配你的屏幕接口)。
2.  **PCB Layout**：
    *   布局：模拟地与数字地分离（音频底噪控制关键）。
    *   走线：SDIO 和 I2S 等高速信号线需注意等长和抗干扰。
3.  **打样与焊接**：嘉立创下单，购买元器件，手工焊接调试。

### 📚 学习重点 (EDA 工具)
*   **工具**：嘉立创 EDA (专业版/标准版) 或 KiCad。
*   **知识点**：
    *   去耦电容的摆放 (靠近引脚)。
    *   晶振的走线 (包地)。
    *   音频电路的降噪设计 (AGND/DGND)。

---

## 阶段五：结构设计 (外壳)
**目标**：给电路板穿上衣服，成为真正的产品。

### 关键任务
1.  **测量**：精确测量 PCB 尺寸、屏幕开孔位置、按键/接口位置。
2.  **建模**：设计外壳，考虑卡扣或螺丝柱。
3.  **制造**：3D 打印 (FDM 或 SLA 光固化)。

### 📚 学习重点
*   **工具**：Fusion 360 (推荐，易上手且功能强大) 或 SolidWorks。
*   **知识点**：公差控制 (打印出来的孔通常会偏小)，卡扣设计结构。

---

## 总结与建议
这是一个非常棒的全栈项目，涵盖了从底层驱动、RTOS、GUI、应用逻辑到硬件设计和结构设计的完整流程。
**建议下一步**：先不要急着画板子。先在开发板上把 **FreeRTOS** 和 **LVGL 音乐播放界面** 跑通，确保软件逻辑没有问题，再进行硬件设计。
