# 音乐播放器内存优化报告

## 优化概述

针对 STM32F407 的内存限制，对音乐播放器进行了全面的内存优化。

## 优化措施及预计节省

### 1. **移除中文字体直接包含** ⭐⭐⭐⭐⭐

- **位置**: `gui_music_player.c`
- **修改**: 注释掉 `lv_font_source_han_sans_sc_14_cjk.c` 的 include
- **节省**: ~200-400KB Flash, ~10-20KB RAM
- **影响**: 界面改用英文/默认字体显示

### 2. **减少 LVGL 内存池**

- **位置**: `lv_conf.h`
- **修改**: `LV_MEM_SIZE` 从 64KB → 48KB
- **节省**: 16KB RAM
- **影响**: 可能需要在运行时监控内存使用

### 3. **减少图层缓冲区**

- **位置**: `lv_conf.h`
- **修改**: `LV_DRAW_LAYER_SIMPLE_BUF_SIZE` 从 24KB → 16KB
- **节省**: 8KB RAM
- **影响**: 复杂图层可能渲染稍慢

### 4. **减少绘图线程堆栈**

- **位置**: `lv_conf.h`
- **修改**: `LV_DRAW_THREAD_STACK_SIZE` 从 8KB → 4KB
- **节省**: 4KB RAM
- **影响**: 需确保不会堆栈溢出

### 5. **移除阴影效果**

- **位置**: `gui_music_player.c` - list_event_cb()
- **修改**: 注释掉阴影相关样式，改用边框
- **节省**: ~2-5KB RAM (运行时)
- **影响**: 视觉效果简化，但更轻量

### 6. **简化列表项样式**

- **位置**: `gui_music_player.c` - list_event_cb()
- **修改**: 减少每个列表项的样式设置调用
- **节省**: ~1-2KB RAM (运行时)
- **影响**: 列表外观使用默认样式

### 7. **减少圆形缓存**

- **位置**: `lv_conf.h`
- **修改**: `LV_DRAW_SW_CIRCLE_CACHE_SIZE` 从 4 → 2
- **节省**: ~100-200 bytes RAM
- **影响**: 圆角渲染稍慢

## 总计节省

### Flash (程序存储器)

- **主要节省**: 200-400KB (移除中文字体)

### RAM (运行内存)

- LVGL 内存池: 16KB
- 图层缓冲区: 8KB
- 绘图线程堆栈: 4KB
- 运行时优化: ~5-10KB
- **总计**: ~33-38KB

## 进一步优化建议

### 如果仍需要更多内存：

1. **减少音频缓冲区**

   - 当前 4KB，可考虑减少到 2KB
   - 文件: `music_player.c`

2. **使用外部 SRAM**

   - STM32F407 支持 FSMC 接口
   - 可将 LVGL 内存池放到外部 SRAM

3. **简化 GUI**

   - 减少同时显示的控件数量
   - 延迟创建弹窗

4. **优化图片资源**

   - 检查图片是否使用了过高的颜色深度
   - 考虑使用压缩格式

5. **禁用未使用的 LVGL 组件**
   - 在 `lv_conf.h` 中禁用不需要的 widgets
   - 例如: Calendar, Chart 等

## 测试建议

编译后请验证：

1. 音乐列表能正常打开和关闭
2. 设置弹窗正常工作
3. 界面流畅度可接受
4. 无内存溢出错误

## 回滚方案

如果优化导致问题，可以逐步恢复：

1. 先恢复 LVGL 内存池到 64KB
2. 恢复图层缓冲区到 24KB
3. 其他配置根据实际情况调整

## 注意事项

- 如果出现分配失败或显示异常，可能需要微调内存配置
- 建议在实际硬件上测试所有功能
- 监控运行时的内存使用情况（可使用 LVGL 的 lv_mem_monitor）
